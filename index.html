<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Money Analyzer</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="filters">
        <h1 style="margin-right: 20px; font-size: 1.2em;">Money Money Analyzer</h1>
        <input type="file" id="csvFile" accept=".csv">
        <button id="loadBtn">Load CSV</button>
        <div id="yearButtons"></div>
        <button id="resetDrillBtn">Reset Drill</button>
    </div>
    <div class="chart-container">
        <canvas id="combinedChart"></canvas>
        <canvas id="growthChart"></canvas>
    </div>
    <div class="table-container">
        <table id="transactionTable">
            <thead>
                <tr>
                    <th data-column="date">Date <input type="text" placeholder="Filter Date"></th>
                    <th data-column="name">Name <input type="text" placeholder="Filter Name"></th>
                    <th data-column="verwendungszweck">Verwendungszweck <input type="text" placeholder="Filter Verwendungszweck"></th>
                    <th data-column="betrag">Betrag <input type="text" placeholder="Filter Betrag"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script type="module">
        import { parse_csv, group_data, data as module_data, filtered_data as module_filtered, current_path, reset_state } from './src/data.js';
        import { render_combined_chart, render_growth_chart } from './src/charts.js';
        import { render_table } from './src/table.js';

        // Wire up UI
        document.getElementById('loadBtn').addEventListener('click', () => {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                localStorage.setItem('csvData', csv);
                parse_csv(csv);
                populate_year_buttons();
                const onBarClick = (cat) => {
                    current_path.push(cat);
                    localStorage.setItem('currentPath', JSON.stringify(current_path));
                    const newGrouped = group_data(module_filtered, current_path.length);
                    render_combined_chart(newGrouped.out, newGrouped.in, 'combinedChart', onBarClick);
                    render_growth_chart(newGrouped.out, 'growthChart');
                    render_table(module_filtered, '#transactionTable tbody', current_path);
                };
                const grouped = group_data(module_filtered, current_path.length);
                render_combined_chart(grouped.out, grouped.in, 'combinedChart', onBarClick);
                render_growth_chart(grouped.out, 'growthChart');
                render_table(module_filtered, '#transactionTable tbody', current_path);
            };
            reader.readAsText(file);
        });

        document.getElementById('resetDrillBtn').addEventListener('click', () => { reset_state(); location.reload(); });

        function populate_year_buttons() {
            const years = [...new Set(module_data.map(d => d.date.getFullYear()))].sort();
            const container = document.getElementById('yearButtons');
            container.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.textContent = 'All Years';
            allBtn.addEventListener('click', () => filter_by_year(''));
            container.appendChild(allBtn);
            years.forEach(y => {
                const btn = document.createElement('button');
                btn.textContent = y;
                btn.addEventListener('click', () => filter_by_year(y));
                container.appendChild(btn);
            });
        }

        function filter_by_year(year) {
            const fd = year ? module_data.filter(d => d.date.getFullYear() == year) : [...module_data];
            localStorage.setItem('selectedYear', year);
            localStorage.setItem('currentPath', JSON.stringify([]));
            const onBarClick = (cat) => {
                current_path.push(cat);
                localStorage.setItem('currentPath', JSON.stringify(current_path));
                const newGrouped = group_data(fd, current_path.length);
                render_combined_chart(newGrouped.out, newGrouped.in, 'combinedChart', onBarClick);
                render_growth_chart(newGrouped.out, 'growthChart');
                render_table(fd, '#transactionTable tbody', current_path);
            };
            const grouped = group_data(fd, 0);
            render_combined_chart(grouped.out, grouped.in, 'combinedChart', onBarClick);
            render_growth_chart(grouped.out, 'growthChart');
            render_table(fd, '#transactionTable tbody', current_path);
        }

        // Restore from localStorage
        window.addEventListener('load', () => {
            const storedCsv = localStorage.getItem('csvData');
            if (storedCsv) {
                parse_csv(storedCsv);
                populate_year_buttons();
                const selectedYear = localStorage.getItem('selectedYear');
                if (selectedYear) filter_by_year(selectedYear);
            }
        });
    </script>
</body>
</html>