<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyMoney Analyzer</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="filters">
        <h1 style="margin-right: 20px; font-size: 1.2em;">MoneyMoney Analyzer</h1>
        <input type="file" id="csvFile" accept=".csv">
        <button id="loadSampleBtn">Load Sample Data</button>
        <div id="yearButtons"></div>
        <button id="resetDrillBtn">Reset Drill</button>
        <span style="margin-left: 20px;">Growth Rate:</span>
        <label><input type="radio" name="growthMode" value="mom" checked> MoM</label>
        <label><input type="radio" name="growthMode" value="yoy"> YoY</label>
        <span style="margin-left: 15px;">Chart:</span>
        <label><input type="radio" name="chartType" value="line" checked> Line</label>
        <label><input type="radio" name="chartType" value="bar"> Bar</label>
    </div>
    <div class="breadcrumbs" id="breadcrumbs"></div>
    <div class="chart-container">
        <canvas id="combinedChart"></canvas>
        <canvas id="growthChart"></canvas>
    </div>
    <div class="table-container">
        <table id="transactionTable">
            <thead>
                <tr>
                    <th data-column="date">Date <input type="text" placeholder="Filter Date"></th>
                    <th data-column="name">Name <input type="text" placeholder="Filter Name"></th>
                    <th data-column="verwendungszweck">Verwendungszweck <input type="text" placeholder="Filter Verwendungszweck"></th>
                    <th data-column="betrag">Betrag <input type="text" placeholder="Filter Betrag"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script type="module">
        import { parse_csv, group_data, data as module_data, filtered_data as module_filtered, current_path, reset_state } from './src/data.js';
        import { render_combined_chart, render_growth_chart } from './src/charts.js';
        import { render_table, init_table_controls } from './src/table.js';

        let currentYear = '';
        let tableControlsInitialized = false;
        let growthMode = 'mom';
        let chartType = 'line';
        
        function render_all() {
            const fd = currentYear ? module_data.filter(d => d.date.getFullYear() == currentYear) : [...module_data];
            const onBarClick = (cat) => {
                current_path.push(cat);
                localStorage.setItem('currentPath', JSON.stringify(current_path));
                render_all();
            };
            const grouped = group_data(fd, current_path.length);
            
            // For YoY growth, we need data from previous year too
            let growthData = fd;
            if (growthMode === 'yoy' && currentYear) {
                const prevYear = parseInt(currentYear) - 1;
                growthData = module_data.filter(d => 
                    d.date.getFullYear() == currentYear || d.date.getFullYear() == prevYear
                );
            }
            const growthGrouped = group_data(growthData, current_path.length);
            
            render_combined_chart(grouped.out, grouped.in, 'combinedChart', onBarClick);
            render_growth_chart(growthGrouped.out, 'growthChart', growthMode, chartType);
            render_table(fd, '#transactionTable tbody', current_path);
            render_breadcrumbs();
            
            // Initialize table controls after first render
            if (!tableControlsInitialized) {
                init_table_controls(() => render_all());
                tableControlsInitialized = true;
            }
        }

        // Wire up UI
        function jsonToCsv(jsonData) {
            const headers = Object.keys(jsonData[0]);
            const csvRows = [headers.join(';')];
            jsonData.forEach(row => {
                const values = headers.map(h => row[h] || '');
                csvRows.push(values.join(';'));
            });
            return csvRows.join('\n');
        }
        
        function loadCsvFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                localStorage.setItem('csvData', csv);
                parse_csv(csv);
                populate_year_buttons();
                tableControlsInitialized = false;
                render_all();
            };
            reader.readAsText(file);
        }
        
        document.getElementById('csvFile').addEventListener('change', (e) => {
            loadCsvFile(e.target.files[0]);
        });
        
        document.getElementById('loadSampleBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('./sample_data.json');
                const jsonData = await response.json();
                const csvData = jsonToCsv(jsonData);
                localStorage.setItem('csvData', csvData);
                parse_csv(csvData);
                populate_year_buttons();
                tableControlsInitialized = false;
                render_all();
            } catch (error) {
                console.error('Error loading sample data:', error);
                alert('Failed to load sample data');
            }
        });

        document.getElementById('resetDrillBtn').addEventListener('click', () => { reset_state(); location.reload(); });
        
        document.querySelectorAll('input[name="growthMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                growthMode = e.target.value;
                if (module_data.length > 0) {
                    render_all();
                }
            });
        });
        
        document.querySelectorAll('input[name="chartType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                chartType = e.target.value;
                if (module_data.length > 0) {
                    render_all();
                }
            });
        });

        function populate_year_buttons() {
            const years = [...new Set(module_data.map(d => d.date.getFullYear()))].sort();
            const container = document.getElementById('yearButtons');
            container.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.textContent = 'All Years';
            allBtn.addEventListener('click', () => filter_by_year(''));
            container.appendChild(allBtn);
            years.forEach(y => {
                const btn = document.createElement('button');
                btn.textContent = y;
                btn.addEventListener('click', () => filter_by_year(y));
                container.appendChild(btn);
            });
        }

        function render_breadcrumbs() {
            const breadcrumbsEl = document.getElementById('breadcrumbs');
            if (current_path.length === 0) {
                breadcrumbsEl.innerHTML = '<span style="color: #999;">All Categories</span>';
                return;
            }
            let html = '<span data-level="-1">All Categories</span>';
            current_path.forEach((cat, idx) => {
                html += ' > <span data-level="' + idx + '">' + cat + '</span>';
            });
            breadcrumbsEl.innerHTML = html;
            
            breadcrumbsEl.querySelectorAll('span[data-level]').forEach(span => {
                const level = parseInt(span.getAttribute('data-level'));
                if (level < current_path.length - 1) {
                    span.addEventListener('click', () => {
                        if (level === -1) {
                            current_path.length = 0;
                        } else {
                            current_path.length = level + 1;
                        }
                        localStorage.setItem('currentPath', JSON.stringify(current_path));
                        render_all();
                    });
                }
            });
        }

        function filter_by_year(year) {
            currentYear = year;
            localStorage.setItem('selectedYear', year);
            current_path.length = 0;
            localStorage.setItem('currentPath', JSON.stringify([]));
            render_all();
        }

        // Restore from localStorage
        window.addEventListener('load', () => {
            const storedCsv = localStorage.getItem('csvData');
            if (storedCsv) {
                parse_csv(storedCsv);
                populate_year_buttons();
                tableControlsInitialized = false;
                const storedPath = localStorage.getItem('currentPath');
                if (storedPath) {
                    const pathArray = JSON.parse(storedPath);
                    pathArray.forEach(p => current_path.push(p));
                }
                const selectedYear = localStorage.getItem('selectedYear');
                currentYear = selectedYear || '';
                render_all();
            }
        });
    </script>
</body>
</html>